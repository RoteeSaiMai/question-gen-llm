# -*- coding: utf-8 -*-

#สร้างชุดคำถาม Multiple choice, ผลลัพธ์ออกเป็น JSON และ CSV file
import ollama
import json
import re
import csv

def extract_json_from_text(text):
    """
    Extracts the first JSON object or array from the text.
    """
    json_match = re.search(r'\[.*\]', text, re.DOTALL)
    if json_match:
        return json_match.group(0)
    return None

def generate_mcq_questions(text, num_questions):
    """
    Generates a specified number of multiple-choice questions from a given text using GEMMA-2-2B via Ollama.
    
    Parameters:
        text (str): The input text to generate questions from.
        num_questions (int): The number of questions to generate.
    
    Returns:
        List[Dict[str, Any]]: A list of dictionaries, each containing a question and its answers.
    """
    prompt = f'''
    สร้างคำถามแบบปรนัยจำนวน {num_questions} ข้อจากข้อความต่อไปนี้ในภาษาไทย 
    พร้อมคำตอบที่ถูกต้อง โดยแสดงคำตอบเป็น ก, ข, ค, ง:
    โปรดจัดรูปแบบคำถามและคำตอบเป็น JSON ตามตัวอย่างต่อไปนี้
    คำตอบจะผ่าน parser ที่รับเป็น JSON เท่านั้น:

    [
        {{
            "question": "หญ้าถูกจัดอยู่ในวงศ์พืชชนิดใด?",
            "choices": {{
                "ก": "วงศ์ทานตะวัน",
                "ข": "วงศ์กล้วยไม้",
                "ค": "วงศ์ถั่ว",
                "ง": "วงศ์หญ้า"
            }},
            "correct_answer": "ง"
        }}
    ]

    โปรดสร้างคำถามและคำตอบในรูปแบบที่แสดงในตัวอย่างข้างต้น และให้คำตอบทุกข้อเป็นภาษาไทยทั้งหมด:
    DO NOT INCLUDE ANYTHING ELSE IN YOUR RESPONSE OTHER THAN THE .JSON FILE.
    ข้อความ: {text}

    สร้างคำถามแบบปรนัยจำนวน {num_questions} ข้อจากข้อความต่อไปนี้ในภาษาไทย 
    พร้อมคำตอบที่ถูกต้อง โดยแสดงคำตอบเป็น ก, ข, ค, ง:
    โปรดจัดรูปแบบคำถามและคำตอบเป็น JSON ตามตัวอย่างต่อไปนี้
    คำตอบจะผ่าน parser ที่รับเป็น JSON เท่านั้น:

    [
        {{
            "question": "หญ้าถูกจัดอยู่ในวงศ์พืชชนิดใด?",
            "choices": {{
                "ก": "วงศ์ทานตะวัน",
                "ข": "วงศ์กล้วยไม้",
                "ค": "วงศ์ถั่ว",
                "ง": "วงศ์หญ้า"
            }},
            "correct_answer": "ง"
        }}
    ]

    โปรดสร้างคำถามและคำตอบในรูปแบบที่แสดงในตัวอย่างข้างต้น และให้คำตอบทุกข้อเป็นภาษาไทยทั้งหมด:
    DO NOT INCLUDE ANYTHING ELSE IN YOUR RESPONSE OTHER THAN THE .JSON FILE.
    '''

    # Use Ollama to generate text
    response = ollama.generate(model="gemma:2b", prompt=prompt, stream=True)
    generated_text = ""
    
    # Stream the response
    for chunk in response:
        data = chunk["response"]
        print(data, end="")
        generated_text += chunk["response"]

    # Process the generated text
    print("\nend of response")

    # Extract the JSON content from the response
    json_content = extract_json_from_text(generated_text)
    
    if json_content:
        try:
            mcq_list = json.loads(json_content)
        except json.JSONDecodeError as e:
            print("Failed to parse JSON:", e)
            mcq_list = []
    else:
        print("No JSON content found.")
        mcq_list = []

    return mcq_list

def save_mcq_to_csv(mcq_list, file_name='mcq_questions_gemma2b.csv'):
    """
    Saves the list of multiple-choice questions to a CSV file.

    Parameters:
        mcq_list (List[Dict[str, Any]]): The list of MCQ questions.
        file_name (str): The name of the file to save the CSV to.
    """
    with open(file_name, mode='w', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        # Write the header
        writer.writerow(['Question', 'ก', 'ข', 'ค', 'ง', 'Correct Answer'])

        # Write the rows
        for mcq in mcq_list:
            writer.writerow([
                mcq['question'],
                mcq['choices'].get('ก', ''),
                mcq['choices'].get('ข', ''),
                mcq['choices'].get('ค', ''),
                mcq['choices'].get('ง', ''),
                mcq['correct_answer']
            ])

# Example usage:
text_input = '''
วิทยาการทางการแพทย์มีการพัฒนาและการคิดค้นสิ่งใหม่ๆ เกิดขึ้นอย่างต่อเนื่องเพื่อให้การทำงานของแพทย์ส่งผลที่ดีที่สุดให้กับผู้ป่วย แต่สิ่งที่น่าเป็นห่วงก็คือ เทคโนโลยีในปัจจุบันนั้นจะเพียงพอและครอบคลุมต่อความต้องการหรือไม่ โดยเฉพาะสำหรับประเทศไทยที่ได้ก้าวเข้าสู่สังคมผู้สูงวัยอย่างเต็มรูปแบบ และมีจำนวนผู้สูงอายุเพิ่มขึ้นมากที่สุดในภูมิภาคเอเชียตะวันออกเฉียงใต้ ดังนั้นสิ่งที่จะตามมาก็คือ ประสิทธิภาพในการรักษา ระยะเวลาในการดูแลและค่าใช้จ่าย โดยเฉพาะอย่างยิ่งจำนวนบุคลากรทางการแพทย์ที่ในปัจจุบันอาจจะยังมีไม่เพียงพอต่อความต้องการ ซึ่งปัญหาเหล่านี้กำลังเป็นปัญหาใหญ่ นอกจากไทยแล้ว ทางซีกโลกตะวันตกก็กำลังประสบปัญหาคล้ายคลึงกัน โดยพบว่าภายในปี พ.ศ.2593 (ค.ศ.2050) หนึ่งในสี่ของประชากรในยุโรปและอเมริกาเหนือจะมีอายุเกิน 65 ปี ซึ่งหมายความว่าระบบโครงสร้างสุขภาพจะต้องดูแลผู้ป่วยที่มีความต้องการที่ซับซ้อนมากยิ่งขึ้นในอนาคต ดังนั้นการพัฒนาของ ‘AI’ หรือปัญญาประดิษฐ์จึงถือว่าเข้ามาได้ถูกจังหวะ เพราะหลายคนเชื่อกันว่า AI อาจจะเป็นเทคโนโลยีที่เหมาะสมในการช่วยแก้ปัญหาเหล่านี้ได้
เลือกอ่าน
AI กับบทบาททางการแพทย์
จริยธรรมของ AI สำหรับใช้ทางการแพทย์
ความยินยอมทางการแพทย์จากคนไข้
ความน่าเชื่อถือและความถูกต้อง
ควรถูกคัดกรองอย่างโปร่งใสโดยปราศจากอคติ
แนวทางในการใช้ AI ให้ตรงกับเป้าหมายทางจริยธรรมการแพทย์
1. ความยินยอมส่วนบุคคล
2. ส่งเสริมความปลอดภัย
3. ความโปร่งใส
4. ความรับผิดชอบ
5. ความเสมอภาค
6. ความยั่งยืน
เลือกโซลูชั่น AI ให้สอดคล้องกับจริยธรรมทางการแพทย์
โครงสร้างพื้นฐานขององค์กรและจริยธรรม AI
ความเชี่ยวชาญที่เหมาะสมกับอุตสาหกรรม
ข้อมูลคุณภาพสูงที่ผ่านการกลั่นกรอง
ประสิทธิภาพของโซลูชั่น AI
AI กับบทบาททางการแพทย์
ข้อมูลของบริษัท McKinsey ที่ร่วมกับ EIT Health ของสหภาพยุโรปพบว่าเทคโนโลยี AI มีส่วนช่วยในการปรับปรุงคุณภาพของการบริการทางด้านสุขภาพได้ แต่ทั้งนี้เนื่องจาก AI เป็นเทคโนโลยีที่ค่อนข้างใหม่ การขยับขยายจึงอาจจะใช้เวลาอยู่พอสมควร ส่วนประเทศไทยนั้น เราอาจจะยังไม่ค่อยเห็น AI กับบทบาททางการแพทย์มากเหมือนเช่นในอุตสาหกรรมการเงินการธนาคาร แต่หากลองหาข้อมูลแบบเจาะลึกจะพบว่าเทคโนโลยี AI กำลังถูกนำมาใช้ทางการแพทย์ในหลายองค์กรทั่วประเทศ และด้วยเหตุนี้จึงทำให้ผู้ปฏิบัติงานอาจจะเกิดข้อสงสัยว่า “การใช้ AI นั้นจะส่งผลกระทบในด้านจริยธรรมหรือไม่” เพราะเรื่องของการรักษาคนไข้นั้นถือเป็นเรื่องที่ค่อนข้างละเอียดอ่อนพอสมควร เนื่องจากเป็นเรื่องที่เกี่ยวข้องกับข้อมูลของคนไข้โดยตรง แม้แต่แพทย์เองก็ยังต้องมีจรรยาบรรณแพทย์ในการปฏิบัติงาน แล้ว AI ที่เป็นปัญญาประดิษฐ์นั้นจะใช้มาตรฐานอะไรมาวัด หรือจะกำหนดให้ถูกหลักตามทำนองคลองธรรมได้อย่างไร

AI หรือ ปัญญาประดิษฐ์นั้นสร้างขึ้นจากวิทยาการคอมพิวเตอร์ ให้มีพัฒนาการทางด้านความคิดและมีความสามารถในการวิเคราะห์ที่คล้ายกับสมองมนุษย์ โดยที่ AI จะสามารถวิเคราะห์ข้อมูลจำนวนมากจากองค์ความรู้ทางด้านการแพทย์ ซึ่งถูกจัดเก็บไว้ในรูปแบบต่างๆ เช่น รูปภาพ การทดลองวิจัยทางคลินิก และการอ้างสิทธิ์ทางการแพทย์ นอกจากนี้ AI ยังสามารถระบุข้อมูลเชิงลึกที่มักตรวจเจอได้ยากอีกด้วย ด้วยเหตุนี้ AI จึงสามารถเพิ่มผลลัพธ์ทางการรักษาและดูแลผู้ป่วยได้อย่างมีประสิทธิภาพมากยิ่งขึ้น ในอีกมุมหนึ่ง AI ก็ช่วยแบ่งเบาภาระบุคลากรทางการแพทย์ได้เช่นกันหากนำไปใช้อย่างเหมาะสม ดังเช่นจากข้อมูลของ Mobi Health News ได้อธิบายเอาไว้ว่า การประมวลผลและการเรียนรู้เชิงลึกของ AI จะทำให้เราค้นพบวิธีการแก้ไขปัญหาทางด้านสุขภาพได้รวดเร็วและแม่นยำมากขึ้น


จริยธรรมของ AI สำหรับใช้ทางการแพทย์
จากข้อมูลข้างต้นจะพบว่า AI เริ่มกลายมาเป็นส่วนหนึ่งของชีวิตประจำวันมากขึ้นเรื่อยๆ ดังจะเห็นได้จากข่าวต่างๆ ที่เราพบได้อยู่ทุกวัน นอกจากนี้องค์กรที่ผลิตเทคโนโลยีระดับโลกต่างๆ อย่าง Microsoft, Facebook, Twitter, Google ต่างก็หันมาตื่นตัวในเรื่องของจริยธรรมในการใช้งานเทคโนโลยี AI ด้วยเช่นกัน
จริยธรรมถือเป็นเรื่องที่มีความสำคัญและมีความอ่อนไหวสูงมากไม่ว่าในอุตสาหกรรมใดก็ตาม สำหรับด้านการแพทย์นั้น เทคโนโลยี AI ถูกนำมาประยุกต์ใช้ในหลากหลายส่วนงาน ซึ่งหากมองในมุมของจริยธรรม AI สิ่งสำคัญที่ละเลยไม่ได้ก็คือ  “การปฏิบัติตามข้อกำหนดทางการแพทย์และหลักจริยธรรมพื้นฐาน”

 
ความยินยอมทางการแพทย์จากคนไข้
ทุกการตรวจและการใช้ข้อมูลของคนไข้จะต้องได้รับความยินยอมจากคนไข้เจ้าของข้อมูลนั้น ๆ 

 
ความน่าเชื่อถือและความถูกต้อง
ต้องคำนึงอยู่เสมอว่า ข้อมูลต่างๆ ที่ถูกรวบรวมนั้นเวลานำไปใช้งานหรือขยายผลจะมีความน่าเชื่อถือและถูกต้องชัดเจนขนาดไหน เพราะการเก็บและวิเคราะห์ข้อมูลจำเป็นต้องใช้ความระมัดระวังในเรื่องของจริยธรรมเป็นอย่างมาก เนื่องจากบางเรื่องถือเป็นเรื่องที่ละเอียดอ่อนควรถูกคัดกรองอย่างโปร่งใสโดยปราศจากอคติ บุคคลใดบ้างที่สามารถเข้าถึงข้อมูลเหล่านี้ได้ การพิจารณาโดยปราศจากอคติในการเลือกปฏิบัติตามเชื้อชาติ เพศ หรือปัจจัยอื่นๆ ซึ่งส่งผลในเชิงจริยธรรมและมนุษยธรรม

ดังนั้นยิ่ง AI ถูกนำมาใช้ในทางการแพทย์มากขึ้นเท่าไหร่ ความเข้าใจและความโปร่งใสจึงเป็นสิ่งจำเป็นมากขึ้นเท่านั้น เพราะไม่ว่าผู้ใช้งานจะเป็นใคร เป็นบุคลากรทางการแพทย์หรือเป็นคนไข้เอง ต่างก็อาจจะได้รับผลกระทบทางด้านจริยธรรมได้ทั้งทางตรงและทางอ้อมด้วยเช่นกัน ด้วยเหตุนี้ทาง Perceptra จึงใส่ใจในทุกรายละเอียดเพื่อสร้างความมั่นใจให้กับผู้ใช้งาน

 
แนวทางในการใช้ AI ให้ตรงกับเป้าหมายทางจริยธรรมการแพทย์
เรื่องของจริยธรรมการใช้ AI สำหรับทางการแพทย์นั้นได้กลายเป็นเรื่องที่องค์กรระดับโลกอย่างองค์การอนามัยโลกหรือ WHO ได้เล็งเห็นถึงความสำคัญ จนถึงขั้นออกแนวทางในการปฏิบัติ 6 ประการ เพื่อให้การใช้ AI สอดคล้องกับจริยธรรมทางการแพทย์ นอกจากนี้แนวทางของ WHO ยังเป็นหลักสากล ซึ่งช่วยในการสร้างรากฐานสำหรับองค์กรทุกประเภทที่เกี่ยวข้องกับจริยธรรม AI ไม่ว่าจะเป็นหน่วยงานรัฐบาล นักพัฒนาซอฟต์แวร์ รวมไปถึงหน่วยงานที่คอยกำกับและดูแลการเข้าถึงเทคโนโลยี โดยหลักการ 6 ประการที่สำคัญมีดังนี้ 

 
1. ความยินยอมส่วนบุคคล
คนไข้ควรได้รับการดูแลและควรเป็นผู้ตัดสินใจตามสิทธิ์ขั้นพื้นฐานของตนเอง ส่วนแพทย์นั้นก็ยังเป็นบุคคลหลักที่ให้คำแนะนำและให้การรักษาตามแนวทางที่เหมาะสม ดังนั้น AI อาจจะเป็นเพียงส่วนประกอบในการให้ข้อมูลเพื่อเป็นแนวทางในการรักษาพยาบาล ทั้งนี้ควรระวังในเรื่องของสิทธิส่วนบุคคล เช่น ข้อมูลส่วนตัว การตัดสินใจของคนไข้ เป็นต้น

 
2. ส่งเสริมความปลอดภัย
เครื่องมือ AI ควรได้รับการตรวจสอบและพัฒนาอย่างต่อเนื่อง โดยเฉพาะในด้านประสิทธิภาพของการทำงาน ความถูกต้อง และความปลอดภัยสำหรับทุกขั้นตอน เพื่อให้มั่นใจว่าการใช้งานจะถูกต้องตามหลักจริยธรรมและมีประสิทธิภาพมากที่สุด

 
3. ความโปร่งใส
เครื่องมือ AI ที่ใช้งานควรมีความโปร่งใส ตรวจสอบได้จากทั้งผู้ใช้งานและหน่วยงานที่กำกับดูแลด้านเทคโนโลยี

 
4. ความรับผิดชอบ
เทคโนโลยี AI ที่เลือกใช้สามารถตรวจสอบที่มาที่ไปได้ โดยเฉพาะในกรณีที่เกิดปัญหาต่อผู้ใช้งานหรือผลกระทบต่อผู้ป่วย โดยควรมีกลไกในการตรวจสอบว่าใครเป็นผู้รับผิดชอบและใช้หลักปฏิบัติอะไรในการรองรับ

 
5. ความเสมอภาค
ระบบที่นำไปใช้งานควรรองรับหลายภาษาเพื่อให้ทุกคนสามารถเข้าถึงได้ โดยต้องปราศจากอคติ เช่น เชื้อชาติ ศาสนา เพศ

 
6. ความยั่งยืน
ระบบที่ผลิตออกมาควรจะสามารถอัปเดตและปรับเปลี่ยนให้มีประสิทธิภาพเพิ่มขึ้นได้อย่างสม่ำเสมอ

 
เลือกโซลูชั่น AI ให้สอดคล้องกับจริยธรรมทางการแพทย์
แม้ว่าทางองค์การอนามัยโลกจะได้ออกหลักการปฏิบัติมาไว้เป็นแนวทางแล้วก็ตาม แต่สิ่งที่สำคัญอีกส่วนที่จะช่วยขับเคลื่อนเทคโนโลยี AI ให้ตอบโจทย์มากยิ่งขึ้นก็คือ แนวทางของผู้ผลิตโซลูชั่นทางด้าน AI โดยหากองค์กรของคุณกำลังมองหาผู้ให้บริการหรือผู้ผลิตโซลูชั่น AI ทางการแพทย์ที่สอดคล้องกับหลักจริยธรรม ต้องไม่ลืมที่จะคำนึงถึงวิธีการทำงาน แนวคิด และนโยบายการปฏิบัติงานของผู้ให้บริการ ที่จะช่วยให้การทำงานของแพทย์และบุคลากรหน้างานมีความคล่องตัวมากขึ้นอย่างแท้จริง ซึ่งสามารถสรุปได้ดังต่อไปนี้

 
โครงสร้างพื้นฐานขององค์กรและจริยธรรม AI
โดยหลักแล้วผู้ให้บริการควรจะมีส่วนประกอบสำคัญอย่างเช่น ฝ่ายบริหาร คณะกรรมการ หรือหน่วยงานกลางที่คอยกำกับดูแลในเรื่องสำคัญที่ครอบคลุมทางด้านจริยธรรม AI อาทิเช่น การกำหนดนโยบายข้อมูลส่วนบุคคล ข้อกำหนดการใช้งาน หลักจริยธรรมสำหรับปฏิบัติ หลักกฎหมาย เป็นต้น

 
ความเชี่ยวชาญที่เหมาะสมกับอุตสาหกรรม
การเลือกใช้ผู้ให้บริการที่มีความเชี่ยวชาญเฉพาะอุตสาหกรรมนั้นๆ ถือเป็นสิ่งสำคัญ เพราะหากขาดความเชี่ยวชาญหรือขาดพื้นฐานความเข้าใจทางด้าน Health Care ก็อาจจะส่งผลกระทบต่อการใช้ระบบ รวมไปถึงอาจจะมีผลกระทบต่อมาตรฐานทางด้านการตัดสินใจตามหลักจริยธรรมได้

 
ข้อมูลคุณภาพสูงที่ผ่านการกลั่นกรอง
จริยธรรมทางการแพทย์นั้นอยู่คู่กับการแพทย์มาอย่างยาวนาน ซึ่งอาจจะไม่สอดคล้องกับสถานการณ์ในปัจจุบันที่แนวทางต่างๆ มีการเปลี่ยนแปลงอยู่ตลอดเวลา ดังนั้น AI ที่นำมาใช้ควรจะให้มุมมองใหม่ๆ ตามแนวทางที่เป็นปัจจุบันและทันสมัยที่สุด ซึ่งสิ่งเหล่านี้จะช่วยเพิ่มประสิทธิภาพในการทำงานได้เป็นอย่างดี แต่ก็ควรตรวจสอบให้มั่นใจว่าโซลูชั่นเหล่านั้น ได้ผ่านการรับรองจากหน่วยงานกลางและมีการคัดกรองข้อมูลมาอย่างละเอียดแล้วหรือไม่

 
ประสิทธิภาพของโซลูชั่น AI
บางครั้ง AI ก็มีบทบาทในการให้ข้อมูลที่ช่วยในการตัดสินใจพอสมควร ดังนั้นโซลูชั่นที่ดีจะต้องพร้อมและเหมาะสมกับหน้างาน มีความรวดเร็วและมีคุณภาพที่เชื่อถือได้ รวมถึงยังสามารถที่จะต่อยอดในการพัฒนาปรับแต่งตามความเหมาะสมได้

สิ่งสุดท้ายที่จะขาดไม่ได้ในการขับเคลื่อนองค์กรและการทำงานก็คือ ผู้ปฏิบัติงาน เพราะแม้ว่า AI จะเป็นสิ่งใหม่ แต่ถ้าหากผู้บริหารในองค์กรช่วยให้ความรู้และความเข้าใจเกี่ยวกับโซลูชั่น AI ว่ามีความสำคัญและมีประโยชน์มากขนาดไหน ข้อมูลดังกล่าวเหล่านี้ก็จะทำให้ผู้ใช้งานเกิดความตระหนักรู้และสามารถทำงานกับเทคโนโลยีใหม่ๆ ได้อย่างมีประสิทธิภาพ เช่น การอธิบายให้ผู้ปฏิบัติงานเห็นว่า AI นั้นไม่ได้มาทดแทนบุคคล แต่มาเพื่อช่วยให้การทำงานรวดเร็วมากขึ้น อีกทั้งการให้การอบรมหรือเทรนนิ่งการใช้งานทั้งทางด้านเทคนิคและจริยธรรมก็ถือเป็นอีกสิ่งที่สำคัญที่ขาดไม่ได้ ด้วยองค์ประกอบต่างๆ เหล่านี้ จะช่วยสร้างความเข้าใจในการใช้งาน AI ให้เหมาะสมกับจริยธรรมทางการแพทย์และเสริมความคล่องตัวในการทำงานได้มากยิ่งขึ้น
'''

if __name__ == "__main__":
    num_questions = 10
    mcq_questions = generate_mcq_questions(text_input, num_questions)

    print('end of response')
    print(mcq_questions)

    # Save the MCQ list to a CSV file
    save_mcq_to_csv(mcq_questions)

    print('CSV file generated successfully.')

